{
  "name": "Daily Worklog to Trello",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 18 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "ë§¤ì¼ 18ì‹œ íŠ¸ë¦¬ê±°",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 200]
    },
    {
      "parameters": {
        "options": {
          "fields": {
            "values": [
              {
                "fieldName": "target_date",
                "fieldType": "string"
              }
            ]
          }
        }
      },
      "id": "manual-trigger",
      "name": "ìˆ˜ë™ íŠ¸ë¦¬ê±° (ë‚ ì§œ ì§€ì • ê°€ëŠ¥)",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 400]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\n\n// ìˆ˜ë™ íŠ¸ë¦¬ê±°ì—ì„œ ë‚ ì§œë¥¼ ì…ë ¥ë°›ì•˜ëŠ”ì§€ í™•ì¸\nconst inputDate = $input.first().json.target_date;\n\nlet year, month, day, dateStr;\n\nif (inputDate && inputDate.trim() !== '') {\n  // ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥ë°›ì€ ë‚ ì§œ ì‚¬ìš© (YYYY-MM-DD í˜•ì‹)\n  const parts = inputDate.trim().split('-');\n  if (parts.length !== 3) {\n    throw new Error('ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');\n  }\n  year = parseInt(parts[0]);\n  month = parts[1];\n  day = parts[2];\n  dateStr = inputDate.trim();\n} else {\n  // ìë™ íŠ¸ë¦¬ê±°ì¸ ê²½ìš° ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©\n  const today = new Date();\n  year = today.getFullYear();\n  month = String(today.getMonth() + 1).padStart(2, '0');\n  day = String(today.getDate()).padStart(2, '0');\n  dateStr = `${year}-${month}-${day}`;\n}\n\nconst filePath = `/Users/ilseok/n8n-weekly-report/daily-worklogs/${year}-${month}/${dateStr}.md`;\n\n// íŒŒì¼ ì¡´ì¬ í™•ì¸\nif (!fs.existsSync(filePath)) {\n  throw new Error(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${filePath}`);\n}\n\n// íŒŒì¼ ì½ê¸°\nconst fileContent = fs.readFileSync(filePath, 'utf8');\n\nreturn {\n  date: dateStr,\n  year: year,\n  month: month,\n  filePath: filePath,\n  fileContent: fileContent\n};"
      },
      "id": "read-worklog",
      "name": "ì—…ë¬´ì¼ì§€ ì½ê¸°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "const fileContent = $input.first().json.fileContent;\nconst filePath = $input.first().json.filePath;\nconst date = $input.first().json.date;\n\n// YAML Front Matter íŒŒì‹±\nconst yamlMatch = fileContent.match(/^---\\n([\\s\\S]*?)\\n---/);\nif (!yamlMatch) {\n  throw new Error('YAML Front Matterë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');\n}\n\nconst yamlContent = yamlMatch[1];\nconst yamlLines = yamlContent.split('\\n');\n\n// trello_synced í™•ì¸\nlet isSynced = false;\nfor (const line of yamlLines) {\n  if (line.trim().startsWith('trello_synced:')) {\n    const value = line.split(':')[1].trim();\n    isSynced = (value === 'true');\n    break;\n  }\n}\n\nif (isSynced) {\n  return [];\n}\n\n// trello_card_mapping íŒŒì‹±\nconst cardMapping = {};\nlet inMapping = false;\n\nfor (const line of yamlLines) {\n  if (line.trim() === 'trello_card_mapping:') {\n    inMapping = true;\n    continue;\n  }\n  \n  if (inMapping) {\n    if (line.startsWith('  ') && line.includes(':')) {\n      const parts = line.trim().split(':');\n      const key = parts[0].trim();\n      const value = parts.slice(1).join(':').trim().replace(/\"/g, '');\n      cardMapping[key] = value;\n    } else if (!line.startsWith(' ')) {\n      inMapping = false;\n    }\n  }\n}\n\n// ë§ˆí¬ë‹¤ìš´ ë³¸ë¬¸ ì¶”ì¶œ\nconst bodyContent = fileContent.replace(/^---\\n[\\s\\S]*?\\n---\\n/, '');\n\n// \"ì˜¤ëŠ˜ ì™„ë£Œí•œ ì—…ë¬´\" í…Œì´ë¸” íŒŒì‹±\nconst completedSection = bodyContent.match(/## ğŸ“Œ ì˜¤ëŠ˜ ì™„ë£Œí•œ ì—…ë¬´\\n([\\s\\S]*?)(?=\\n## |$)/);\nconst tasks = [];\n\nif (completedSection) {\n  const tableContent = completedSection[1];\n  const rows = tableContent.split('\\n').filter(line => line.startsWith('|') && !line.includes('---'));\n  \n  // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° í–‰ë§Œ ì²˜ë¦¬\n  for (let i = 1; i < rows.length; i++) {\n    const cells = rows[i].split('|').map(cell => cell.trim()).filter(cell => cell);\n    \n    if (cells.length >= 4) {\n      const category = cells[0];\n      const task = cells[1];\n      const time = cells[2];\n      const difficulty = cells[3];\n      \n      // ì¹´í…Œê³ ë¦¬ì— í•´ë‹¹í•˜ëŠ” ì¹´ë“œ ID ì°¾ê¸°\n      const cardId = cardMapping[category];\n      \n      if (cardId && cardId !== 'ì—¬ê¸°ì—_ì¹´ë“œID_ì…ë ¥') {\n        tasks.push({\n          category: category,\n          task: task,\n          time: time,\n          difficulty: difficulty,\n          cardId: cardId,\n          filePath: filePath,\n          date: date\n        });\n      }\n    }\n  }\n}\n\nif (tasks.length === 0) {\n  return [];\n}\n\nreturn tasks.map(task => ({ json: task }));"
      },
      "id": "parse-content",
      "name": "ì—…ë¬´ì¼ì§€ íŒŒì‹±",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-tasks",
      "name": "ì—…ë¬´ í•­ëª© ë°˜ë³µ",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [900, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.trello.com/1/cards/{{ $json.cardId }}/actions/comments",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "trelloApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "=âœ… {{ $json.task }}\\nâ±ï¸ ì†Œìš”ì‹œê°„: {{ $json.time }} | ë‚œì´ë„: {{ $json.difficulty }}\\nğŸ“… ì‘ì—…ì¼: {{ $json.date }}"
            }
          ]
        },
        "options": {}
      },
      "id": "add-trello-comment",
      "name": "Trello ëŒ“ê¸€ ì¶”ê°€",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1120, 300],
      "credentials": {
        "trelloApi": {
          "id": "1",
          "name": "Trello account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $node['ì—…ë¬´ í•­ëª© ë°˜ë³µ'].json.done }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-loop-done",
      "name": "ë°˜ë³µ ì™„ë£Œ í™•ì¸",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst filePath = $input.first().json.filePath;\n\n// íŒŒì¼ ì½ê¸°\nlet fileContent = fs.readFileSync(filePath, 'utf8');\n\n// trello_synced: falseë¥¼ trueë¡œ ë³€ê²½\nfileContent = fileContent.replace(/trello_synced:\\s*false/, 'trello_synced: true');\n\n// íŒŒì¼ ì“°ê¸°\nfs.writeFileSync(filePath, fileContent, 'utf8');\n\nreturn {\n  filePath: filePath,\n  status: 'synced',\n  message: 'Trello ë™ê¸°í™” ì™„ë£Œ'\n};"
      },
      "id": "update-sync-status",
      "name": "ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 200]
    },
    {
      "parameters": {},
      "id": "no-op",
      "name": "ê³„ì† ë°˜ë³µ",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1560, 400]
    }
  ],
  "connections": {
    "ë§¤ì¼ 18ì‹œ íŠ¸ë¦¬ê±°": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ì¼ì§€ ì½ê¸°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ìˆ˜ë™ íŠ¸ë¦¬ê±° (ë‚ ì§œ ì§€ì • ê°€ëŠ¥)": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ì¼ì§€ ì½ê¸°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì—…ë¬´ì¼ì§€ ì½ê¸°": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ì¼ì§€ íŒŒì‹±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì—…ë¬´ì¼ì§€ íŒŒì‹±": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ í•­ëª© ë°˜ë³µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì—…ë¬´ í•­ëª© ë°˜ë³µ": {
      "main": [
        [
          {
            "node": "Trello ëŒ“ê¸€ ì¶”ê°€",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trello ëŒ“ê¸€ ì¶”ê°€": {
      "main": [
        [
          {
            "node": "ë°˜ë³µ ì™„ë£Œ í™•ì¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë°˜ë³µ ì™„ë£Œ í™•ì¸": {
      "main": [
        [
          {
            "node": "ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ê³„ì† ë°˜ë³µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ê³„ì† ë°˜ë³µ": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ í•­ëª© ë°˜ë³µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
