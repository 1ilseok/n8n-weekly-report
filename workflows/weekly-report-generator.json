{
  "name": "Weekly Report Generator",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * 5"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "ë§¤ì£¼ ê¸ˆìš”ì¼ 8ì‹œ íŠ¸ë¦¬ê±°",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 200]
    },
    {
      "parameters": {
        "options": {
          "fields": {
            "values": [
              {
                "fieldName": "target_week",
                "fieldType": "string"
              }
            ]
          }
        }
      },
      "id": "manual-trigger",
      "name": "ìˆ˜ë™ íŠ¸ë¦¬ê±° (ì£¼ì°¨ ì§€ì •)",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 400]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\n\n// ìˆ˜ë™ íŠ¸ë¦¬ê±°ì—ì„œ ì£¼ì°¨ë¥¼ ì…ë ¥ë°›ì•˜ëŠ”ì§€ í™•ì¸\nconst inputWeek = $input.first().json.target_week;\n\nlet startDate, endDate;\n\nif (inputWeek && inputWeek.trim() !== '') {\n  // ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥ë°›ì€ ì£¼ì°¨ ì‚¬ìš© (YYYY-WW í˜•ì‹, ì˜ˆ: 2025-01)\n  const parts = inputWeek.trim().split('-');\n  if (parts.length !== 2) {\n    throw new Error('ì£¼ì°¨ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. YYYY-WW í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 2025-01)');\n  }\n  const year = parseInt(parts[0]);\n  const weekNum = parseInt(parts[1]);\n  \n  // í•´ë‹¹ ì—°ë„ì˜ ì²« ê¸ˆìš”ì¼ ì°¾ê¸°\n  let firstFriday = new Date(year, 0, 1);\n  while (firstFriday.getDay() !== 5) {\n    firstFriday = new Date(firstFriday.getTime() + 86400000);\n  }\n  \n  // í•´ë‹¹ ì£¼ì°¨ì˜ ê¸ˆìš”ì¼ (ì‹œì‘ì¼)\n  startDate = new Date(firstFriday.getTime() + (weekNum - 1) * 7 * 86400000);\n  // í•´ë‹¹ ì£¼ì°¨ì˜ ëª©ìš”ì¼ (ì¢…ë£Œì¼) - ê¸ˆìš”ì¼ë¶€í„° 6ì¼ í›„\n  endDate = new Date(startDate.getTime() + 6 * 86400000);\n} else {\n  // ìë™ íŠ¸ë¦¬ê±°ì¸ ê²½ìš° (ë§¤ì£¼ ê¸ˆìš”ì¼ 8ì‹œ ì‹¤í–‰)\n  // ì§€ë‚œì£¼ ê¸ˆìš”ì¼ë¶€í„° ì´ë²ˆì£¼ ëª©ìš”ì¼ê¹Œì§€ì˜ ì—…ë¬´ì¼ì§€ ì§‘ê³„\n  const today = new Date();\n  \n  // ì§€ë‚œì£¼ ê¸ˆìš”ì¼ (ì˜¤ëŠ˜ ê¸ˆìš”ì¼ë¡œë¶€í„° -7ì¼)\n  startDate = new Date(today.getTime() - 7 * 86400000);\n  // ì´ë²ˆì£¼ ëª©ìš”ì¼ (ì˜¤ëŠ˜ ê¸ˆìš”ì¼ë¡œë¶€í„° -1ì¼)\n  endDate = new Date(today.getTime() - 1 * 86400000);\n}\n\n// ë‚ ì§œë³„ íŒŒì¼ ê²½ë¡œ ìƒì„± (ê¸ˆ~ëª©, 7ì¼ê°„)\nconst dailyFiles = [];\nfor (let i = 0; i < 7; i++) {\n  const date = new Date(startDate.getTime() + i * 86400000);\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  const dateStr = `${year}-${month}-${day}`;\n  \n  const filePath = `/Users/ilseok/n8n-weekly-report/daily-worklogs/${year}-${month}/${dateStr}.md`;\n  \n  if (fs.existsSync(filePath)) {\n    dailyFiles.push({\n      date: dateStr,\n      filePath: filePath\n    });\n  }\n}\n\nif (dailyFiles.length === 0) {\n  throw new Error(`í•´ë‹¹ ì£¼ê°„ì˜ ì—…ë¬´ì¼ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (${startDate.toISOString().split('T')[0]} ~ ${endDate.toISOString().split('T')[0]})`);\n}\n\n// ì£¼ì°¨ ì •ë³´ ê³„ì‚° (ê¸ˆìš”ì¼ ì‹œì‘ ê¸°ì¤€)\nconst startYear = startDate.getFullYear();\nlet firstFriday = new Date(startYear, 0, 1);\nwhile (firstFriday.getDay() !== 5) {\n  firstFriday = new Date(firstFriday.getTime() + 86400000);\n}\nconst weekNumber = Math.floor((startDate.getTime() - firstFriday.getTime()) / (7 * 86400000)) + 1;\n\nreturn {\n  weekNumber: weekNumber,\n  year: startYear,\n  startDate: startDate.toISOString().split('T')[0],\n  endDate: endDate.toISOString().split('T')[0],\n  dailyFiles: dailyFiles\n};"
      },
      "id": "calculate-week",
      "name": "ì£¼ì°¨ ë° ë‚ ì§œ ê³„ì‚°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst dailyFiles = $input.first().json.dailyFiles;\n\n// ëª¨ë“  ì¼ì¼ ì—…ë¬´ì¼ì§€ íŒŒì‹±\nconst allTasks = {\n  completed: [],\n  inProgress: [],\n  nextWeek: []\n};\n\nfor (const fileInfo of dailyFiles) {\n  const fileContent = fs.readFileSync(fileInfo.filePath, 'utf8');\n  const date = fileInfo.date;\n  \n  // YAML Front Matter íŒŒì‹±\n  const yamlMatch = fileContent.match(/^---\\n([\\s\\S]*?)\\n---/);\n  if (!yamlMatch) continue;\n  \n  const yamlContent = yamlMatch[1];\n  const yamlLines = yamlContent.split('\\n');\n  \n  // trello_card_mapping íŒŒì‹±\n  const cardMapping = {};\n  let inMapping = false;\n  \n  for (const line of yamlLines) {\n    if (line.trim() === 'trello_card_mapping:') {\n      inMapping = true;\n      continue;\n    }\n    \n    if (inMapping) {\n      if (line.startsWith('  ') && line.includes(':')) {\n        const parts = line.trim().split(':');\n        const key = parts[0].trim();\n        const value = parts.slice(1).join(':').trim().replace(/\"/g, '');\n        cardMapping[key] = value;\n      } else if (!line.startsWith(' ')) {\n        inMapping = false;\n      }\n    }\n  }\n  \n  // ë§ˆí¬ë‹¤ìš´ ë³¸ë¬¸ ì¶”ì¶œ\n  const bodyContent = fileContent.replace(/^---\\n[\\s\\S]*?\\n---\\n/, '');\n  \n  // \"ì˜¤ëŠ˜ ì™„ë£Œí•œ ì—…ë¬´\" íŒŒì‹±\n  const completedSection = bodyContent.match(/## ğŸ“Œ ì˜¤ëŠ˜ ì™„ë£Œí•œ ì—…ë¬´\\n([\\s\\S]*?)(?=\\n## |$)/);\n  if (completedSection) {\n    const tableContent = completedSection[1];\n    const rows = tableContent.split('\\n').filter(line => line.startsWith('|') && !line.includes('---'));\n    \n    for (let i = 1; i < rows.length; i++) {\n      const cells = rows[i].split('|').map(cell => cell.trim()).filter(cell => cell);\n      \n      if (cells.length >= 4) {\n        allTasks.completed.push({\n          date: date,\n          category: cells[0],\n          task: cells[1],\n          time: cells[2],\n          difficulty: cells[3]\n        });\n      }\n    }\n  }\n  \n  // \"ì§„í–‰ ì¤‘ì¸ ì—…ë¬´\" íŒŒì‹±\n  const inProgressSection = bodyContent.match(/## ğŸš§ ì§„í–‰ ì¤‘ì¸ ì—…ë¬´\\n([\\s\\S]*?)(?=\\n## |$)/);\n  if (inProgressSection) {\n    const tableContent = inProgressSection[1];\n    const rows = tableContent.split('\\n').filter(line => line.startsWith('|') && !line.includes('---'));\n    \n    for (let i = 1; i < rows.length; i++) {\n      const cells = rows[i].split('|').map(cell => cell.trim()).filter(cell => cell);\n      \n      if (cells.length >= 3) {\n        allTasks.inProgress.push({\n          date: date,\n          category: cells[0],\n          task: cells[1],\n          progress: cells[2]\n        });\n      }\n    }\n  }\n  \n  // \"ë‚´ì¼ í•  ì¼\" íŒŒì‹± (ê¸ˆìš”ì¼ë§Œ)\n  if (new Date(date).getDay() === 5) {\n    const nextSection = bodyContent.match(/## ğŸ“‹ ë‚´ì¼ í•  ì¼\\n([\\s\\S]*?)(?=\\n## |$)/);\n    if (nextSection) {\n      const tableContent = nextSection[1];\n      const rows = tableContent.split('\\n').filter(line => line.startsWith('|') && !line.includes('---'));\n      \n      for (let i = 1; i < rows.length; i++) {\n        const cells = rows[i].split('|').map(cell => cell.trim()).filter(cell => cell);\n        \n        if (cells.length >= 3) {\n          allTasks.nextWeek.push({\n            category: cells[0],\n            task: cells[1],\n            priority: cells[2]\n          });\n        }\n      }\n    }\n  }\n}\n\nreturn {\n  weekNumber: $input.first().json.weekNumber,\n  year: $input.first().json.year,\n  startDate: $input.first().json.startDate,\n  endDate: $input.first().json.endDate,\n  dailyFiles: dailyFiles.map(f => f.filePath),\n  tasks: allTasks\n};"
      },
      "id": "parse-worklogs",
      "name": "ì—…ë¬´ì¼ì§€ íŒŒì‹±",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.OPENAI_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": []
        },
        "specifyBody": "json",
        "jsonBody": "={{ \n  {\n    \"model\": \"gpt-4o-mini\",\n    \"temperature\": 0.3,\n    \"messages\": [\n      {\n        \"role\": \"system\",\n        \"content\": \"ë‹¹ì‹ ì€ ì£¼ê°„ ì—…ë¬´ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì¼ì¼ ì—…ë¬´ì¼ì§€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ íšŒì‚¬ í˜•ì‹ì— ë§ëŠ” ì£¼ê°„ë³´ê³ ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.\\n\\nì£¼ìš” ì—­í• :\\n1. ì¤‘ë³µ ì—…ë¬´ í†µí•©: ê°™ì€ Redmine ì¼ê° ë²ˆí˜¸ë‚˜ ìœ ì‚¬í•œ ì—…ë¬´ëŠ” í•˜ë‚˜ë¡œ í†µí•©\\n2. ìµœì‹  ìƒíƒœ ë°˜ì˜: ì—¬ëŸ¬ ë‚ ì— ê±¸ì³ ì§„í–‰ëœ ì—…ë¬´ëŠ” ìµœì¢… ìƒíƒœë¡œ ì—…ë°ì´íŠ¸\\n3. ì‹œê°„ ì§‘ê³„: ê°™ì€ ì—…ë¬´ì— ì†Œìš”ëœ ì´ ì‹œê°„ ê³„ì‚°\\n4. ì¹´í…Œê³ ë¦¬ë³„ ë¶„ë¥˜: Redmine, ìë™í™”, ê¸°íƒ€ ì—…ë¬´ë¡œ ëª…í™•íˆ êµ¬ë¶„\\n5. ì£¼ìš” ì„±ê³¼ ìš”ì•½: ê°€ì¥ ì¤‘ìš”í•œ ì—…ë¬´ 3-5ê°œ ì„ ë³„\\n6. íŠ¹ì´ì‚¬í•­ ê°ì§€: ì¼ì • ì§€ì—°, ì˜ˆìƒì™¸ ì´ìŠˆ, ì¤‘ìš” ê²°ì • ë“± ìë™ íŒŒì•…\\n\\nì¶œë ¥ í˜•ì‹ì€ ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ì´ì–´ì•¼ í•˜ë©°, YAML Front Matterë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.\"\n      },\n      {\n        \"role\": \"user\",\n        \"content\": `ì£¼ê°„ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.\\n\\n## ê¸°ë³¸ ì •ë³´\\n- ì£¼ì°¨: ${$input.first().json.year}ë…„ ${$input.first().json.weekNumber}ì£¼ì°¨\\n- ê¸°ê°„: ${$input.first().json.startDate} ~ ${$input.first().json.endDate}\\n- ì‘ì„±ì: ilseok\\n\\n## íŒŒì‹±ëœ ì—…ë¬´ ë°ì´í„°\\n\\n### ì™„ë£Œí•œ ì—…ë¬´\\n${JSON.stringify($input.first().json.tasks.completed, null, 2)}\\n\\n### ì§„í–‰ ì¤‘ì¸ ì—…ë¬´\\n${JSON.stringify($input.first().json.tasks.inProgress, null, 2)}\\n\\n### ë‹¤ìŒ ì£¼ ê³„íš\\n${JSON.stringify($input.first().json.tasks.nextWeek, null, 2)}\\n\\n## ì‘ì„± ìš”êµ¬ì‚¬í•­\\n\\n1. **YAML Front Matter í¬í•¨**: week_number, year, start_date, end_date, author, generated_at í•„ë“œ í¬í•¨\\n2. **ì¤‘ë³µ ì œê±°**: ê°™ì€ Redmine ì¼ê°(ì˜ˆ: #123)ì´ ì—¬ëŸ¬ ë‚  ë‚˜íƒ€ë‚˜ë©´ í•˜ë‚˜ë¡œ í†µí•©í•˜ê³  ì´ ì†Œìš” ì‹œê°„ í•©ì‚°\\n3. **ìƒíƒœ ì—…ë°ì´íŠ¸**: ì§„í–‰ ì¤‘ì¸ ì—…ë¬´ê°€ ì™„ë£Œë¡œ ë°”ë€ ê²½ìš° ìµœì‹  ìƒíƒœ ë°˜ì˜\\n4. **ì¹´í…Œê³ ë¦¬ë³„ í…Œì´ë¸”**:\\n   - Redmine ì¼ê°: | ìƒíƒœ | ì¼ê°ë²ˆí˜¸ | ì œëª© | ë‹´ë‹¹ì | ë¹„ê³  |\\n   - ìë™í™” í…ŒìŠ¤íŠ¸ (Server-i, WebKeeper, PV ë“±): | ìƒíƒœ | ë¶„ë¥˜ | ì—…ë¬´ ë‚´ìš© | ë¹„ê³  |\\n   - ê¸°íƒ€ ì—…ë¬´: | ìƒíƒœ | ë¶„ë¥˜ | ì—…ë¬´ ë‚´ìš© | ë¹„ê³  |\\n5. **ë‹¤ìŒ ì£¼ ê³„íš**: | ìš°ì„ ìˆœìœ„ | ë¶„ë¥˜ | ì—…ë¬´ ë‚´ìš© | ì˜ˆìƒ ì™„ë£Œì¼ |\\n6. **ì£¼ê°„ ìš”ì•½**:\\n   - í†µê³„: ì´ ì‘ì—… ì‹œê°„, ì™„ë£Œ ì—…ë¬´ ìˆ˜, ì§„í–‰ ì¤‘ ì—…ë¬´ ìˆ˜\\n   - ì£¼ìš” ì„±ê³¼: ê°€ì¥ ì¤‘ìš”í•œ 3-5ê°œ ì—…ë¬´ (ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë ¸ê±°ë‚˜ ë‚œì´ë„ê°€ ë†’ì€ ì—…ë¬´ ìš°ì„ )\\n   - íŠ¹ì´ì‚¬í•­: ì˜ˆìƒì¹˜ ëª»í•œ ì´ìŠˆ, ì¼ì • ë³€ê²½, ì¤‘ìš” ê²°ì • ë“± ìë™ ê°ì§€í•˜ì—¬ ì‘ì„±\\n\\në°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ê³ , ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì„ ì¤€ìˆ˜í•˜ì„¸ìš”.`\n      }\n    ]\n  }\n}}",
        "options": {}
      },
      "id": "openai-generate",
      "name": "AI ì£¼ê°„ë³´ê³ ì„œ ìƒì„±",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst weekNumber = $input.first().json.weekNumber;\nconst year = $input.first().json.year;\n\n// OpenAI API ì‘ë‹µì—ì„œ ìƒì„±ëœ ë³´ê³ ì„œ ì¶”ì¶œ\nconst openaiResponse = $input.first().json;\nconst weeklyReport = openaiResponse.choices[0].message.content;\n\n// ì£¼ê°„ ë³´ê³ ì„œ ë””ë ‰í† ë¦¬ ìƒì„±\nconst reportsDir = `/Users/ilseok/n8n-weekly-report/weekly-reports/${year}`;\nif (!fs.existsSync(reportsDir)) {\n  fs.mkdirSync(reportsDir, { recursive: true });\n}\n\n// íŒŒì¼ëª…: YYYY-WW.md\nconst weekNumStr = String(weekNumber).padStart(2, '0');\nconst fileName = `${year}-${weekNumStr}.md`;\nconst filePath = `${reportsDir}/${fileName}`;\n\n// íŒŒì¼ ì €ì¥\nfs.writeFileSync(filePath, weeklyReport, 'utf8');\n\nreturn {\n  filePath: filePath,\n  fileName: fileName,\n  weekNumber: weekNumber,\n  year: year,\n  status: 'success',\n  message: `AIê°€ ìƒì„±í•œ ì£¼ê°„ ë³´ê³ ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`\n};"
      },
      "id": "save-report",
      "name": "ì£¼ê°„ ë³´ê³ ì„œ ì €ì¥",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    }
  ],
  "connections": {
    "ë§¤ì£¼ ê¸ˆìš”ì¼ 8ì‹œ íŠ¸ë¦¬ê±°": {
      "main": [
        [
          {
            "node": "ì£¼ì°¨ ë° ë‚ ì§œ ê³„ì‚°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ìˆ˜ë™ íŠ¸ë¦¬ê±° (ì£¼ì°¨ ì§€ì •)": {
      "main": [
        [
          {
            "node": "ì£¼ì°¨ ë° ë‚ ì§œ ê³„ì‚°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì£¼ì°¨ ë° ë‚ ì§œ ê³„ì‚°": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ì¼ì§€ íŒŒì‹±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì—…ë¬´ì¼ì§€ íŒŒì‹±": {
      "main": [
        [
          {
            "node": "AI ì£¼ê°„ë³´ê³ ì„œ ìƒì„±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI ì£¼ê°„ë³´ê³ ì„œ ìƒì„±": {
      "main": [
        [
          {
            "node": "ì£¼ê°„ ë³´ê³ ì„œ ì €ì¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
