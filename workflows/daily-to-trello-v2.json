{
  "name": "Daily Worklog to Trello v2 (AI ê¸°ë°˜)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 18 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "ë§¤ì¼ 18ì‹œ íŠ¸ë¦¬ê±°",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 200]
    },
    {
      "parameters": {
        "options": {
          "fields": {
            "values": [
              {
                "fieldName": "target_date",
                "fieldType": "string"
              }
            ]
          }
        }
      },
      "id": "manual-trigger",
      "name": "ìˆ˜ë™ íŠ¸ë¦¬ê±° (ë‚ ì§œ ì§€ì • ê°€ëŠ¥)",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 400]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\n\n// ìˆ˜ë™ íŠ¸ë¦¬ê±°ì—ì„œ ë‚ ì§œë¥¼ ì…ë ¥ë°›ì•˜ëŠ”ì§€ í™•ì¸\nconst inputDate = $input.first().json.target_date;\n\nlet year, month, day, dateStr;\n\nif (inputDate && inputDate.trim() !== '') {\n  // ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥ë°›ì€ ë‚ ì§œ ì‚¬ìš© (YYYY-MM-DD í˜•ì‹)\n  const parts = inputDate.trim().split('-');\n  if (parts.length !== 3) {\n    throw new Error('ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');\n  }\n  year = parseInt(parts[0]);\n  month = parts[1];\n  day = parts[2];\n  dateStr = inputDate.trim();\n} else {\n  // ìë™ íŠ¸ë¦¬ê±°ì¸ ê²½ìš° ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©\n  const today = new Date();\n  year = today.getFullYear();\n  month = String(today.getMonth() + 1).padStart(2, '0');\n  day = String(today.getDate()).padStart(2, '0');\n  dateStr = `${year}-${month}-${day}`;\n}\n\nconst filePath = `/Users/ilseok/ë‚´ ë“œë¼ì´ë¸Œ/n8n-weekly-report/daily-worklogs/${year}-${month}/${dateStr}.md`;\n\n// íŒŒì¼ ì¡´ì¬ í™•ì¸\nif (!fs.existsSync(filePath)) {\n  throw new Error(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${filePath}`);\n}\n\n// íŒŒì¼ ì½ê¸°\nconst fileContent = fs.readFileSync(filePath, 'utf8');\n\nreturn {\n  date: dateStr,\n  year: year,\n  month: month,\n  filePath: filePath,\n  fileContent: fileContent\n};"
      },
      "id": "read-worklog",
      "name": "ì—…ë¬´ì¼ì§€ ì½ê¸°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "const fileContent = $input.first().json.fileContent;\nconst filePath = $input.first().json.filePath;\nconst date = $input.first().json.date;\n\n// YAML Front Matter íŒŒì‹±\nconst yamlMatch = fileContent.match(/^---\\n([\\s\\S]*?)\\n---/);\nif (!yamlMatch) {\n  throw new Error('YAML Front Matterë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');\n}\n\nconst yamlContent = yamlMatch[1];\nconst yamlLines = yamlContent.split('\\n');\n\n// trello_synced í™•ì¸\nlet isSynced = false;\nfor (const line of yamlLines) {\n  if (line.trim().startsWith('trello_synced:')) {\n    const value = line.split(':')[1].trim();\n    isSynced = (value === 'true');\n    break;\n  }\n}\n\nif (isSynced) {\n  return [];\n}\n\n// trello_card_mapping íŒŒì‹± (ì—…ë¬´ëª…: ì§§ì€ID í˜•ì‹)\nconst cardMapping = {};\nlet inMapping = false;\n\nfor (const line of yamlLines) {\n  if (line.trim() === 'trello_card_mapping:') {\n    inMapping = true;\n    continue;\n  }\n  \n  if (inMapping) {\n    // ì£¼ì„ ë¼ì¸ ê±´ë„ˆë›°ê¸°\n    if (line.trim().startsWith('#')) {\n      continue;\n    }\n    \n    if (line.startsWith('  ') && line.includes(':')) {\n      const colonIndex = line.indexOf(':');\n      const key = line.substring(0, colonIndex).trim();\n      const value = line.substring(colonIndex + 1).trim().replace(/\"/g, '');\n      \n      if (key && value && value !== 'ì—¬ê¸°ì—_ì¹´ë“œID_ì…ë ¥') {\n        cardMapping[key] = value;\n      }\n    } else if (!line.startsWith(' ')) {\n      inMapping = false;\n    }\n  }\n}\n\n// ë§ˆí¬ë‹¤ìš´ ë³¸ë¬¸ ì¶”ì¶œ\nconst bodyContent = fileContent.replace(/^---\\n[\\s\\S]*?\\n---\\n/, '');\n\n// \"ì˜¤ëŠ˜ ì™„ë£Œí•œ ì—…ë¬´\" í…Œì´ë¸” íŒŒì‹±\nconst completedSection = bodyContent.match(/## ğŸ“Œ ì˜¤ëŠ˜ ì™„ë£Œí•œ ì—…ë¬´\\n([\\s\\S]*?)(?=\\n## |$)/);\nconst tasks = [];\n\nif (completedSection) {\n  const tableContent = completedSection[1];\n  const rows = tableContent.split('\\n').filter(line => line.startsWith('|') && !line.includes('---'));\n  \n  // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° í–‰ë§Œ ì²˜ë¦¬\n  for (let i = 1; i < rows.length; i++) {\n    const cells = rows[i].split('|').map(cell => cell.trim()).filter(cell => cell);\n    \n    if (cells.length >= 4) {\n      const category = cells[0];\n      const task = cells[1];\n      const time = cells[2];\n      const difficulty = cells[3];\n      \n      tasks.push({\n        category: category,\n        task: task,\n        time: time,\n        difficulty: difficulty,\n        filePath: filePath,\n        date: date,\n        availableCards: cardMapping  // AIê°€ ì„ íƒí•  ìˆ˜ ìˆëŠ” ì¹´ë“œ ëª©ë¡\n      });\n    }\n  }\n}\n\nif (tasks.length === 0) {\n  return [];\n}\n\nreturn tasks.map(task => ({ json: task }));"
      },
      "id": "parse-content",
      "name": "ì—…ë¬´ì¼ì§€ íŒŒì‹±",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-tasks",
      "name": "ì—…ë¬´ í•­ëª© ë°˜ë³µ",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [900, 300]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ë‹¤ìŒ ì—…ë¬´ ë‚´ìš©ì„ ë¶„ì„í•˜ê³ , ê°€ì¥ ê´€ë ¨ì„±ì´ ë†’ì€ Trello ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.\n\n**ì—…ë¬´ ì •ë³´:**\n- ì¹´í…Œê³ ë¦¬: {{ $json.category }}\n- ì—…ë¬´ ë‚´ìš©: {{ $json.task }}\n- ì†Œìš”ì‹œê°„: {{ $json.time }}\n- ë‚œì´ë„: {{ $json.difficulty }}\n\n**ì„ íƒ ê°€ëŠ¥í•œ Trello ì¹´ë“œ:**\n{{ JSON.stringify($json.availableCards, null, 2) }}\n\n**ìš”êµ¬ì‚¬í•­:**\n1. ì—…ë¬´ ë‚´ìš©ê³¼ ì¹´í…Œê³ ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ê°€ì¥ ì í•©í•œ ì¹´ë“œë¥¼ 1ê°œ ì„ íƒ\n2. ê´€ë ¨ì„±ì´ ë†’ì€ ì¹´ë“œê°€ ì—†ë‹¤ë©´ \"ê¸°íƒ€ ì—…ë¬´\" ì¹´ë“œ ì„ íƒ\n3. JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ: {\"selectedCard\": \"ì¹´ë“œëª…\", \"shortLink\": \"ì§§ì€ID\", \"reason\": \"ì„ íƒ ì´ìœ \"}\n\n**ì‘ë‹µ ì˜ˆì‹œ:**\n{\"selectedCard\": \"Privacy-i MacOS Agent ìë™í™”\", \"shortLink\": \"VHYpqMEd\", \"reason\": \"MacOS Agent ê´€ë ¨ ì—…ë¬´ì´ë¯€ë¡œ í•´ë‹¹ ì¹´ë“œê°€ ê°€ì¥ ì í•©í•©ë‹ˆë‹¤.\"}",
        "options": {
          "systemMessage": "ë‹¹ì‹ ì€ ì—…ë¬´ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ Trello ì¹´ë“œë¥¼ ì„ íƒí•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•­ìƒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”."
        }
      },
      "id": "ai-select-card",
      "name": "AI ì¹´ë“œ ì„ íƒ",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [1120, 300],
      "credentials": {
        "openAiApi": {
          "id": "1",
          "name": "OpenAI account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const aiResponse = $input.first().json.response;\nconst originalData = $input.first().json;\n\n// AI ì‘ë‹µ íŒŒì‹±\nlet selectedCard;\ntry {\n  // JSON í˜•ì‹ ì¶”ì¶œ (ì½”ë“œ ë¸”ë¡ ì œê±°)\n  const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    selectedCard = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('JSON í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');\n  }\n} catch (error) {\n  // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš© (ê¸°íƒ€ ì—…ë¬´ ì¹´ë“œ)\n  console.error('AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', error);\n  selectedCard = {\n    selectedCard: \"ê¸°íƒ€ ì—…ë¬´\",\n    shortLink: originalData.availableCards[\"ê¸°íƒ€ ì—…ë¬´\"] || \"PepODzWV\",\n    reason: \"AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨ë¡œ ê¸°ë³¸ ì¹´ë“œ ì‚¬ìš©\"\n  };\n}\n\nreturn {\n  category: originalData.category,\n  task: originalData.task,\n  time: originalData.time,\n  difficulty: originalData.difficulty,\n  date: originalData.date,\n  filePath: originalData.filePath,\n  selectedCardName: selectedCard.selectedCard,\n  shortLink: selectedCard.shortLink,\n  aiReason: selectedCard.reason\n};"
      },
      "id": "parse-ai-response",
      "name": "AI ì‘ë‹µ íŒŒì‹±",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.trello.com/1/cards/{{ $json.shortLink }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "=a8dfec8230225111cb4b4f9272db3192"
            },
            {
              "name": "token",
              "value": "=ATTA6305660ff802054079b9f055800877d7ee11a4624ee4560c78cbc1225218549d69FC000D"
            },
            {
              "name": "fields",
              "value": "id,name"
            }
          ]
        },
        "options": {}
      },
      "id": "get-card-id",
      "name": "ì§§ì€IDë¡œ ê¸´ID ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.trello.com/1/cards/{{ $json.id }}/actions/comments",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "=âœ… {{ $node['AI ì‘ë‹µ íŒŒì‹±'].json.task }}\\nâ±ï¸ ì†Œìš”ì‹œê°„: {{ $node['AI ì‘ë‹µ íŒŒì‹±'].json.time }} | ë‚œì´ë„: {{ $node['AI ì‘ë‹µ íŒŒì‹±'].json.difficulty }}\\nğŸ“… ì‘ì—…ì¼: {{ $node['AI ì‘ë‹µ íŒŒì‹±'].json.date }}\\nğŸ¤– AI ì„ íƒ ì´ìœ : {{ $node['AI ì‘ë‹µ íŒŒì‹±'].json.aiReason }}"
            }
          ]
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "=a8dfec8230225111cb4b4f9272db3192"
            },
            {
              "name": "token",
              "value": "=ATTA6305660ff802054079b9f055800877d7ee11a4624ee4560c78cbc1225218549d69FC000D"
            }
          ]
        },
        "options": {}
      },
      "id": "add-trello-comment",
      "name": "Trello ëŒ“ê¸€ ì¶”ê°€",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $node['ì—…ë¬´ í•­ëª© ë°˜ë³µ'].json.done }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-loop-done",
      "name": "ë°˜ë³µ ì™„ë£Œ í™•ì¸",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst filePath = $node['AI ì‘ë‹µ íŒŒì‹±'].json.filePath;\n\n// íŒŒì¼ ì½ê¸°\nlet fileContent = fs.readFileSync(filePath, 'utf8');\n\n// trello_synced: falseë¥¼ trueë¡œ ë³€ê²½\nfileContent = fileContent.replace(/trello_synced:\\s*false/, 'trello_synced: true');\n\n// íŒŒì¼ ì“°ê¸°\nfs.writeFileSync(filePath, fileContent, 'utf8');\n\nreturn {\n  filePath: filePath,\n  status: 'synced',\n  message: 'Trello ë™ê¸°í™” ì™„ë£Œ'\n};"
      },
      "id": "update-sync-status",
      "name": "ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 200]
    },
    {
      "parameters": {},
      "id": "no-op",
      "name": "ê³„ì† ë°˜ë³µ",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [2220, 400]
    }
  ],
  "connections": {
    "ë§¤ì¼ 18ì‹œ íŠ¸ë¦¬ê±°": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ì¼ì§€ ì½ê¸°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ìˆ˜ë™ íŠ¸ë¦¬ê±° (ë‚ ì§œ ì§€ì • ê°€ëŠ¥)": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ì¼ì§€ ì½ê¸°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì—…ë¬´ì¼ì§€ ì½ê¸°": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ì¼ì§€ íŒŒì‹±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì—…ë¬´ì¼ì§€ íŒŒì‹±": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ í•­ëª© ë°˜ë³µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì—…ë¬´ í•­ëª© ë°˜ë³µ": {
      "main": [
        [
          {
            "node": "AI ì¹´ë“œ ì„ íƒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI ì¹´ë“œ ì„ íƒ": {
      "main": [
        [
          {
            "node": "AI ì‘ë‹µ íŒŒì‹±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI ì‘ë‹µ íŒŒì‹±": {
      "main": [
        [
          {
            "node": "ì§§ì€IDë¡œ ê¸´ID ì¡°íšŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì§§ì€IDë¡œ ê¸´ID ì¡°íšŒ": {
      "main": [
        [
          {
            "node": "Trello ëŒ“ê¸€ ì¶”ê°€",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trello ëŒ“ê¸€ ì¶”ê°€": {
      "main": [
        [
          {
            "node": "ë°˜ë³µ ì™„ë£Œ í™•ì¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë°˜ë³µ ì™„ë£Œ í™•ì¸": {
      "main": [
        [
          {
            "node": "ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ê³„ì† ë°˜ë³µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ê³„ì† ë°˜ë³µ": {
      "main": [
        [
          {
            "node": "ì—…ë¬´ í•­ëª© ë°˜ë³µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
